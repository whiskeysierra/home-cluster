#!/bin/bash

set -euo pipefail

# TODO -d/--dry-run support

root() {
  git rev-parse --show-toplevel
}

wait-for() {
  echo "Waiting for '$3' $1 to become $2..."
  kubectl wait --for=condition="$2" --all "$1" --timeout=60s --namespace "$3"
}

deploy() {
  directory=$1
  component="$(realpath --relative-to="$(root)" "$directory")"
  namespace="$(basename "$directory")"
  echo "Deploying '$component'..."
  kustomize build --enable-alpha-plugins "$directory" | kubectl apply -f -
  wait-for deployments available "$namespace"
  wait-for daemonsets available "$namespace"
  wait-for pods ready "$namespace"
}

defaults() {
  base="$(root)"
  awk '{print "'"$base"'/" $0}' "$base/components.lst"
}

components="${*:-$(defaults)}"

for component in $components; do
  deploy "$component"
done
