#!/bin/bash

set -euo pipefail

deploy() {
  echo "Deploying '$1'..."
  kustomize build --enable-alpha-plugins "$(git rev-parse --show-toplevel)/$1" | kubectl apply -f -
}

await() {
  kubectl rollout status "$2" --timeout 0s --insecure-skip-tls-verify --namespace "$1"
}

components="${*:-metallb pihole ingress-nginx router web-view}"

for component in $components; do
  case $component in
    metallb)
      deploy metallb
      await metallb-system deployment/controller
      await metallb-system daemonset/speaker
      ;;
    pihole)
      deploy pihole
      await pihole deployment/pihole
      ;;
    ingress-nginx)
      deploy ingress-nginx
      await ingress-nginx deployment/ingress-nginx-controller
      ;;
    router)
      deploy router
      ;;
    web-view)
      deploy web-view
      await web-view deployment/kube-web-view
      ;;
    *)
      echo "Unknown component '$component'"
      ;;
  esac
done
