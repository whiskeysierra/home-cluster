#!/bin/bash

set -euo pipefail

wait-for() {
  namespace="$(basename "$3")"
  echo "Waiting for '$namespace' $1 to become $2..."
  kubectl wait --for=condition="$2" --all "$1" --timeout=60s --namespace "$namespace"
}

deploy() {
  echo "Deploying '$1'..."
  kustomize build --enable-alpha-plugins "$(git rev-parse --show-toplevel)/$1" | kubectl apply -f -
  wait-for deployments available "$1"
  wait-for pods ready "$1"
}

components="${*:-network/metallb network/ingress-nginx dns/pihole network/router web-view}"

for component in $components; do
  deploy "$component"
done
